<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanAI - AI-Powered Cleaning Platform</title>

  <!-- Demo-only: Tailwind Play CDN (see README for production build) -->
  <link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">

</head>

<body>
  <!-- Language gate -->
  <div id="langGate" class="fixed inset-0 bg-[#282828] flex items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="langGateTitle">
    <div class="text-center animate px-8">
      <div class="w-16 h-16 bg-white flex items-center justify-center mx-auto mb-6 text-3xl" aria-hidden="true">üè†</div>
      <h1 id="langGateTitle" class="text-5xl font-light text-white mb-2">CleanAI</h1>
      <p id="langGateSubtitle" class="text-lg text-muted mb-8">Select your language</p>

      <div class="grid grid-cols-2 gap-6 max-w-md mx-auto mb-8" role="group" aria-label="Language selection">
        <button type="button" onclick="selectLanguage('en')" class="glass-card p-8 hover:bg-[rgba(255,255,255,0.05)] transition">
          <div class="text-4xl mb-3" aria-hidden="true">üá¨üáß</div><div class="text-lg font-light text-white">English</div>
        </button>
        <button type="button" onclick="selectLanguage('de')" class="glass-card p-8 hover:bg-[rgba(255,255,255,0.05)] transition">
          <div class="text-4xl mb-3" aria-hidden="true">üá©üá™</div><div class="text-lg font-light text-white">Deutsch</div>
        </button>
        <button type="button" onclick="selectLanguage('sv')" class="glass-card p-8 hover:bg-[rgba(255,255,255,0.05)] transition">
          <div class="text-4xl mb-3" aria-hidden="true">üá∏üá™</div><div class="text-lg font-light text-white">Svenska</div>
        </button>
        <button type="button" onclick="selectLanguage('es')" class="glass-card p-8 hover:bg-[rgba(255,255,255,0.05)] transition">
          <div class="text-4xl mb-3" aria-hidden="true">üá™üá∏</div><div class="text-lg font-light text-white">Espa√±ol</div>
        </button>
      </div>

      <div class="flex items-center justify-center gap-2 text-sm">
        <input type="checkbox" id="rememberLang" checked class="w-4 h-4 accent-white cursor-pointer">
        <label for="rememberLang" id="rememberLangLabel" class="text-muted cursor-pointer select-none">Remember my choice</label>
      </div>
    </div>
  </div>

  <!-- Main site -->
  <div id="site" class="hidden min-h-screen">
    <nav class="header-bar sticky top-0 z-40 backdrop-blur-xl">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-white flex items-center justify-center text-[#282828] font-bold text-sm" aria-hidden="true">C</div>
          <span class="text-lg font-medium text-white">CleanAI</span>
        </div>

        <div class="flex items-center gap-8">
          <button type="button" onclick="navigate('home')" class="text-muted hover:text-white font-light text-sm transition pb-1" id="navHome">Home</button>
          <button type="button" onclick="navigate('pricing')" class="text-muted hover:text-white font-light text-sm transition pb-1" id="navPricing">Pricing</button>
          <button type="button" onclick="navigate('features')" class="text-muted hover:text-white font-light text-sm transition pb-1" id="navFeatures">Features</button>
          <button type="button" onclick="changeLanguage()" class="text-muted hover:text-white font-light text-sm transition" title="Change language" aria-label="Change language">üåê</button>
          <button type="button" onclick="openDemoModal()" class="btn-primary px-5 py-2 text-sm font-medium" id="navCTA">Request Demo</button>
        </div>
      </div>
    </nav>

    <div id="content"></div>

    <footer class="header-bar mt-20">
      <div class="max-w-7xl mx-auto px-6 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
          <div>
            <div class="flex items-center gap-3 mb-4">
              <div class="w-8 h-8 bg-white flex items-center justify-center text-[#282828] font-bold text-sm" aria-hidden="true">C</div>
              <span class="text-lg font-medium text-white">CleanAI</span>
            </div>
            <p class="text-sm text-muted font-light" id="footerTagline">AI-powered cleaning management</p>
          </div>
          <div>
            <h3 class="text-sm font-medium text-white mb-4" id="footerProduct">Product</h3>
            <ul class="space-y-2">
              <li><button type="button" onclick="navigate('features')" class="text-sm text-muted hover:text-white transition" id="footerFeatures">Features</button></li>
              <li><button type="button" onclick="navigate('pricing')" class="text-sm text-muted hover:text-white transition" id="footerPricing">Pricing</button></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-medium text-white mb-4" id="footerCompany">Company</h3>
            <ul class="space-y-2">
              <li><a href="#" class="text-sm text-muted hover:text-white transition" id="footerAbout">About</a></li>
              <li><a href="#" class="text-sm text-muted hover:text-white transition" id="footerSecurity">Security</a></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-medium text-white mb-4" id="footerLegal">Legal</h3>
            <ul class="space-y-2">
              <li><a href="#" class="text-sm text-muted hover:text-white transition" id="footerPrivacy">Privacy</a></li>
              <li><a href="#" class="text-sm text-muted hover:text-white transition" id="footerTerms">Terms</a></li>
              <li><button type="button" onclick="changeLanguage()" class="text-sm text-muted hover:text-white transition" id="footerChangeLanguage">Change Language</button></li>
            </ul>
          </div>
        </div>
        <div class="border-t border-white/10 pt-8">
          <p class="text-sm text-muted text-center" id="footerCopyright">¬© 2025 CleanAI. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- Demo modal -->
  <div id="demoModal" class="modal" role="dialog" aria-modal="true" aria-label="Request demo modal">
    <div class="glass-card p-8 max-w-lg w-full mx-4 max-h-[90vh] overflow-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-light text-white" id="demoModalTitle">Request Demo</h2>
        <button type="button" onclick="closeDemoModal()" class="text-white hover:text-muted text-2xl transition" aria-label="Close modal">√ó</button>
      </div>
      <form id="demoForm" onsubmit="submitDemo(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-light text-white mb-2" id="demoNameLabel">Name *</label>
            <input type="text" id="demoName" required class="w-full bg-[#363636] border border-white/10 text-white text-sm px-4 py-2.5 outline-none focus:border-white/20 transition">
          </div>
          <div>
            <label class="block text-sm font-light text-white mb-2" id="demoEmailLabel">Email *</label>
            <input type="email" id="demoEmail" required class="w-full bg-[#363636] border border-white/10 text-white text-sm px-4 py-2.5 outline-none focus:border-white/20 transition">
          </div>
          <div>
            <label class="block text-sm font-light text-white mb-2" id="demoCompanyLabel">Company *</label>
            <input type="text" id="demoCompany" required class="w-full bg-[#363636] border border-white/10 text-white text-sm px-4 py-2.5 outline-none focus:border-white/20 transition">
          </div>

          <div id="demoSuccess" class="success-text hidden" role="status"></div>

          <button type="submit" class="btn-primary w-full px-4 py-2.5 text-sm font-medium" id="demoSubmit">Submit Request</button>
        </div>
      </form>
    </div>
  </div>

  <!-- AI FAB -->
  <button type="button" onclick="aiToggle()" id="aiFab"
    class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-white text-[#282828] flex items-center justify-center text-2xl hover:opacity-90 transition shadow-lg"
    aria-label="Toggle AI assistant" title="AI Assistant">üí¨</button>

  <!-- AI widget -->
  <div id="ai" class="hidden fixed bottom-24 right-6 z-50 w-96 max-w-[calc(100vw-3rem)] glass-card shadow-2xl" role="dialog" aria-label="AI assistant">
    <div class="header-bar p-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-white/10 flex items-center justify-center text-white text-xs" aria-hidden="true">AI</div>
        <span class="text-sm font-medium text-white" id="aiTitle">AI Assistant</span>
        <span class="pill" id="aiStatusPill" title="API status">API: ‚Ä¶</span>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" onclick="aiReset()" class="text-white/60 hover:text-white text-sm transition" title="New chat" aria-label="New chat">üîÑ</button>
        <button type="button" onclick="aiToggle()" class="text-white/60 hover:text-white text-xl transition" aria-label="Close AI assistant">√ó</button>
      </div>
    </div>

    <div id="msgs" class="p-4 h-96 overflow-y-auto space-y-4 bg-[#282828]" aria-live="polite"></div>
    <div id="quick" class="p-3 flex flex-wrap gap-2 bg-[#2c2c2e] border-t border-white/10"></div>

    <div class="p-4 bg-[#2c2c2e] border-t border-white/10">
      <div class="flex gap-2">
        <input type="text" id="inp" placeholder="Type a message..."
          class="flex-1 bg-[#363636] border border-white/10 text-white text-sm px-4 py-2.5 outline-none focus:border-white/20 transition placeholder:text-[#B6B6C1]"
          onkeydown="if(event.key==='Enter'){ event.preventDefault(); queueSendFromInput(); }" />
        <button type="button" onclick="queueSendFromInput()" id="sendBtn" class="btn-primary px-4 py-2.5 text-sm font-medium">Send</button>
      </div>
    </div>
  </div>

  <script>
    // ================= TRANSLATIONS =================
    const T = {
      en: {
        langGateTitle: 'CleanAI', langGateSubtitle: 'Select your language', rememberLangLabel: 'Remember my choice',
        navHome: 'Home', navPricing: 'Pricing', navFeatures: 'Features', navCTA: 'Request Demo',
        heroTitle: 'AI-Powered Cleaning Management',
        heroSubtitle: 'Transform your cleaning operations with intelligent automation, real-time tracking, and data-driven insights.',
        heroCTA: 'Request Demo', heroSecondary: 'Learn More',
        featuresTitle: 'Powerful Features', featuresSubtitle: 'Everything you need to manage your cleaning operations efficiently',
        feature1Title: 'Smart Scheduling', feature1Desc: 'AI-optimized scheduling that adapts to your needs',
        feature2Title: 'Real-time Tracking', feature2Desc: 'Monitor all cleaning activities in real-time',
        feature3Title: 'Quality Control', feature3Desc: 'Automated quality checks and reporting',
        feature4Title: 'Analytics Dashboard', feature4Desc: 'Data-driven insights for better decisions',
        pricingTitle: 'Simple, Transparent Pricing', pricingSubtitle: 'Choose the plan that fits your needs',
        starterTitle: 'Starter', starterPrice: '49', starterPer: 'per month', starterDesc: 'Perfect for small teams', starterCTA: 'Get Started',
        proTitle: 'Professional', proPrice: '149', proPer: 'per month', proDesc: 'For growing businesses', proCTA: 'Get Started',
        enterpriseTitle: 'Enterprise', enterprisePrice: 'Custom', enterprisePer: 'pricing', enterpriseDesc: 'For large organizations', enterpriseCTA: 'Contact Sales',
        faqTitle: 'Frequently Asked Questions',
        faqQ1: 'How does the free trial work?', faqA1: 'You get 14 days of full access to all features. No credit card required.',
        faqQ2: 'Can I change my plan later?', faqA2: 'Yes, you can upgrade or downgrade at any time.',
        faqQ3: 'What payment methods do you accept?', faqA3: 'We accept all major credit cards and bank transfers.',
        faqQ4: 'Is my data secure?', faqA4: 'Yes, we use enterprise-grade security and encryption.',
        ctaTitle: 'Ready to Get Started?', ctaSubtitle: 'Join thousands of companies already using CleanAI', ctaCTA: 'Request Demo',
        footerTagline: 'AI-powered cleaning management', footerProduct: 'Product', footerFeatures: 'Features', footerPricing: 'Pricing',
        footerCompany: 'Company', footerAbout: 'About', footerSecurity: 'Security',
        footerLegal: 'Legal', footerPrivacy: 'Privacy', footerTerms: 'Terms', footerChangeLanguage: 'Change Language',
        footerCopyright: '¬© 2025 CleanAI. All rights reserved.',
        demoModalTitle: 'Request Demo', demoNameLabel: 'Name *', demoEmailLabel: 'Email *', demoCompanyLabel: 'Company *', demoSubmit: 'Submit Request',
        demoSuccess: 'Thank you! We will contact you soon.',
        aiTitle: 'AI Assistant',
        aiWelcome: 'Hi! How can I help you today?',
        aiResetConfirm: 'Start new conversation?',
        aiFileProtoError: 'You opened this page via file://. Please run the local server so /api/ai/chat works.',
        aiApiMissingError: 'AI API not found (404). Ensure the backend is running and serving /api/ai/chat.',
        aiGenericError: 'AI request failed. Please try again.',
        aiOfflineError: 'You appear to be offline. Check your internet connection.',
        aiTimeoutError: 'Request timeout. Please try again.',
        aiRateLimitError: 'Rate limit reached. Please wait a few seconds and try again.',
        aiQueueFullError: 'Too many queued messages. Please wait for the reply.'
      },
      de: {
        langGateTitle: 'CleanAI', langGateSubtitle: 'W√§hlen Sie Ihre Sprache', rememberLangLabel: 'Auswahl merken',
        navHome: 'Startseite', navPricing: 'Preise', navFeatures: 'Funktionen', navCTA: 'Demo anfordern',
        heroTitle: 'KI-gest√ºtzte Reinigungsverwaltung', heroSubtitle: 'Transformieren Sie Ihre Reinigungsabl√§ufe mit intelligenter Automatisierung.',
        heroCTA: 'Demo anfordern', heroSecondary: 'Mehr erfahren',
        featuresTitle: 'Leistungsstarke Funktionen', featuresSubtitle: 'Alles f√ºr effiziente Reinigungsverwaltung',
        feature1Title: 'Intelligente Planung', feature1Desc: 'KI-optimierte Planung',
        feature2Title: 'Echtzeit-Tracking', feature2Desc: '√úberwachung in Echtzeit',
        feature3Title: 'Qualit√§tskontrolle', feature3Desc: 'Automatisierte Qualit√§tspr√ºfungen',
        feature4Title: 'Analytics Dashboard', feature4Desc: 'Datengesteuerte Einblicke',
        pricingTitle: 'Einfache Preise', pricingSubtitle: 'W√§hlen Sie Ihren Plan',
        starterTitle: 'Starter', starterPrice: '49', starterPer: 'pro Monat', starterDesc: 'F√ºr kleine Teams', starterCTA: 'Jetzt starten',
        proTitle: 'Professional', proPrice: '149', proPer: 'pro Monat', proDesc: 'F√ºr wachsende Unternehmen', proCTA: 'Jetzt starten',
        enterpriseTitle: 'Enterprise', enterprisePrice: 'Individuell', enterprisePer: 'Preisgestaltung', enterpriseDesc: 'F√ºr gro√üe Organisationen', enterpriseCTA: 'Vertrieb kontaktieren',
        faqTitle: 'H√§ufige Fragen',
        faqQ1: 'Wie funktioniert die Testversion?', faqA1: '14 Tage voller Zugriff, keine Kreditkarte.',
        faqQ2: 'Plan sp√§ter √§ndern?', faqA2: 'Ja, jederzeit.',
        faqQ3: 'Zahlungsmethoden?', faqA3: 'Alle g√§ngigen Kreditkarten.',
        faqQ4: 'Sind Daten sicher?', faqA4: 'Ja, Sicherheit auf Unternehmensniveau.',
        ctaTitle: 'Bereit loszulegen?', ctaSubtitle: 'Tausende nutzen bereits CleanAI', ctaCTA: 'Demo anfordern',
        footerTagline: 'KI-gest√ºtzte Reinigungsverwaltung', footerProduct: 'Produkt', footerFeatures: 'Funktionen', footerPricing: 'Preise',
        footerCompany: 'Unternehmen', footerAbout: '√úber uns', footerSecurity: 'Sicherheit',
        footerLegal: 'Rechtliches', footerPrivacy: 'Datenschutz', footerTerms: 'Bedingungen', footerChangeLanguage: 'Sprache √§ndern',
        footerCopyright: '¬© 2025 CleanAI. Alle Rechte vorbehalten.',
        demoModalTitle: 'Demo anfordern', demoNameLabel: 'Name *', demoEmailLabel: 'E-Mail *', demoCompanyLabel: 'Firma *', demoSubmit: 'Anfrage senden',
        demoSuccess: 'Vielen Dank! Wir melden uns bald.',
        aiTitle: 'KI-Assistent',
        aiWelcome: 'Hallo! Wie kann ich helfen?',
        aiResetConfirm: 'Neue Konversation starten?',
        aiFileProtoError: 'Du hast die Seite via file:// ge√∂ffnet. Bitte Server starten, damit /api/ai/chat funktioniert.',
        aiApiMissingError: 'AI API nicht gefunden (404). Stelle sicher, dass das Backend l√§uft.',
        aiGenericError: 'AI-Anfrage fehlgeschlagen. Bitte erneut versuchen.',
        aiOfflineError: 'Du bist offline. Bitte Internetverbindung pr√ºfen.',
        aiTimeoutError: 'Zeit√ºberschreitung. Bitte erneut versuchen.',
        aiRateLimitError: 'Rate-Limit erreicht. Bitte kurz warten und erneut versuchen.',
        aiQueueFullError: 'Zu viele Nachrichten in der Warteschlange. Bitte warten.'
      },
      sv: {
        langGateTitle: 'CleanAI', langGateSubtitle: 'V√§lj ditt spr√•k', rememberLangLabel: 'Kom ih√•g mitt val',
        navHome: 'Hem', navPricing: 'Priser', navFeatures: 'Funktioner', navCTA: 'Beg√§r demo',
        heroTitle: 'AI-driven st√§dhantering', heroSubtitle: 'Transformera dina st√§doperationer med intelligent automation.',
        heroCTA: 'Beg√§r demo', heroSecondary: 'L√§s mer',
        featuresTitle: 'Kraftfulla funktioner', featuresSubtitle: 'Allt du beh√∂ver f√∂r effektiv st√§dhantering',
        feature1Title: 'Smart schemal√§ggning', feature1Desc: 'AI-optimerad schemal√§ggning',
        feature2Title: 'Realtidssp√•rning', feature2Desc: '√ñvervaka i realtid',
        feature3Title: 'Kvalitetskontroll', feature3Desc: 'Automatiserade kontroller',
        feature4Title: 'Analysinstrumentpanel', feature4Desc: 'Datadrivna insikter',
        pricingTitle: 'Enkel priss√§ttning', pricingSubtitle: 'V√§lj din plan',
        starterTitle: 'Start', starterPrice: '49', starterPer: 'per m√•nad', starterDesc: 'F√∂r sm√• team', starterCTA: 'Kom ig√•ng',
        proTitle: 'Professionell', proPrice: '149', proPer: 'per m√•nad', proDesc: 'F√∂r v√§xande f√∂retag', proCTA: 'Kom ig√•ng',
        enterpriseTitle: 'F√∂retag', enterprisePrice: 'Anpassad', enterprisePer: 'priss√§ttning', enterpriseDesc: 'F√∂r stora organisationer', enterpriseCTA: 'Kontakta f√∂rs√§ljning',
        faqTitle: 'Vanliga fr√•gor',
        faqQ1: 'Hur fungerar provperioden?', faqA1: '14 dagars full tillg√•ng, inget kort.',
        faqQ2: '√Ñndra plan senare?', faqA2: 'Ja, n√§r som helst.',
        faqQ3: 'Betalningsmetoder?', faqA3: 'Alla st√∂rre kreditkort.',
        faqQ4: '√Ñr data s√§kra?', faqA4: 'Ja, s√§kerhet p√• f√∂retagsniv√•.',
        ctaTitle: 'Redo att b√∂rja?', ctaSubtitle: 'Tusentals anv√§nder CleanAI', ctaCTA: 'Beg√§r demo',
        footerTagline: 'AI-driven st√§dhantering', footerProduct: 'Produkt', footerFeatures: 'Funktioner', footerPricing: 'Priser',
        footerCompany: 'F√∂retag', footerAbout: 'Om oss', footerSecurity: 'S√§kerhet',
        footerLegal: 'Juridiskt', footerPrivacy: 'Integritet', footerTerms: 'Villkor', footerChangeLanguage: 'Byt spr√•k',
        footerCopyright: '¬© 2025 CleanAI. Alla r√§ttigheter f√∂rbeh√•llna.',
        demoModalTitle: 'Beg√§r demo', demoNameLabel: 'Namn *', demoEmailLabel: 'E-post *', demoCompanyLabel: 'F√∂retag *', demoSubmit: 'Skicka f√∂rfr√•gan',
        demoSuccess: 'Tack! Vi kontaktar dig snart.',
        aiTitle: 'AI-assistent',
        aiWelcome: 'Hej! Hur kan jag hj√§lpa?',
        aiResetConfirm: 'Ny konversation?',
        aiFileProtoError: 'Du √∂ppnade sidan via file://. Starta servern s√• /api/ai/chat fungerar.',
        aiApiMissingError: 'AI API saknas (404). S√§kerst√§ll att backend k√∂rs.',
        aiGenericError: 'AI-f√∂rfr√•gan misslyckades. F√∂rs√∂k igen.',
        aiOfflineError: 'Du verkar vara offline. Kontrollera din anslutning.',
        aiTimeoutError: 'Tidsgr√§ns n√•dd. F√∂rs√∂k igen.',
        aiRateLimitError: 'Rate limit n√•dd. V√§nta n√•gra sekunder och f√∂rs√∂k igen.',
        aiQueueFullError: 'F√∂r m√•nga meddelanden i k√∂. V√§nta p√• svaret.'
      },
      es: {
        langGateTitle: 'CleanAI', langGateSubtitle: 'Seleccione su idioma', rememberLangLabel: 'Recordar mi elecci√≥n',
        navHome: 'Inicio', navPricing: 'Precios', navFeatures: 'Caracter√≠sticas', navCTA: 'Solicitar demo',
        heroTitle: 'Gesti√≥n de limpieza con IA', heroSubtitle: 'Transforme sus operaciones con automatizaci√≥n inteligente.',
        heroCTA: 'Solicitar demo', heroSecondary: 'Saber m√°s',
        featuresTitle: 'Caracter√≠sticas potentes', featuresSubtitle: 'Todo para gestionar eficientemente',
        feature1Title: 'Programaci√≥n inteligente', feature1Desc: 'Programaci√≥n optimizada por IA',
        feature2Title: 'Seguimiento en tiempo real', feature2Desc: 'Supervisi√≥n en tiempo real',
        feature3Title: 'Control de calidad', feature3Desc: 'Controles automatizados',
        feature4Title: 'Panel de an√°lisis', feature4Desc: 'Informaci√≥n basada en datos',
        pricingTitle: 'Precios simples', pricingSubtitle: 'Elija su plan',
        starterTitle: 'Inicial', starterPrice: '49', starterPer: 'por mes', starterDesc: 'Para equipos peque√±os', starterCTA: 'Comenzar',
        proTitle: 'Profesional', proPrice: '149', proPer: 'por mes', proDesc: 'Para empresas en crecimiento', proCTA: 'Comenzar',
        enterpriseTitle: 'Empresa', enterprisePrice: 'Personalizado', enterprisePer: 'precio', enterpriseDesc: 'Para grandes organizaciones', enterpriseCTA: 'Contactar ventas',
        faqTitle: 'Preguntas frecuentes',
        faqQ1: '¬øC√≥mo funciona la prueba?', faqA1: '14 d√≠as de acceso completo, sin tarjeta.',
        faqQ2: '¬øCambiar plan despu√©s?', faqA2: 'S√≠, en cualquier momento.',
        faqQ3: '¬øM√©todos de pago?', faqA3: 'Todas las tarjetas principales.',
        faqQ4: '¬øDatos seguros?', faqA4: 'S√≠, seguridad empresarial.',
        ctaTitle: '¬øListo para comenzar?', ctaSubtitle: 'Miles usan CleanAI', ctaCTA: 'Solicitar demo',
        footerTagline: 'Gesti√≥n de limpieza con IA', footerProduct: 'Producto', footerFeatures: 'Caracter√≠sticas', footerPricing: 'Precios',
        footerCompany: 'Empresa', footerAbout: 'Acerca de', footerSecurity: 'Seguridad',
        footerLegal: 'Legal', footerPrivacy: 'Privacidad', footerTerms: 'T√©rminos', footerChangeLanguage: 'Cambiar idioma',
        footerCopyright: '¬© 2025 CleanAI. Todos los derechos reservados.',
        demoModalTitle: 'Solicitar demo', demoNameLabel: 'Nombre *', demoEmailLabel: 'Correo *', demoCompanyLabel: 'Empresa *', demoSubmit: 'Enviar solicitud',
        demoSuccess: '¬°Gracias! Nos pondremos en contacto pronto.',
        aiTitle: 'Asistente IA',
        aiWelcome: '¬°Hola! ¬øC√≥mo puedo ayudarte?',
        aiResetConfirm: '¬øNueva conversaci√≥n?',
        aiFileProtoError: 'Abriste la p√°gina con file://. Ejecuta el servidor para que /api/ai/chat funcione.',
        aiApiMissingError: 'AI API no encontrado (404). Aseg√∫rate de que el backend est√© en ejecuci√≥n.',
        aiGenericError: 'Fallo en la solicitud de IA. Int√©ntalo de nuevo.',
        aiOfflineError: 'Parece que est√°s sin conexi√≥n. Revisa tu internet.',
        aiTimeoutError: 'Tiempo agotado. Int√©ntalo de nuevo.',
        aiRateLimitError: 'Rate limit alcanzado. Espera unos segundos e int√©ntalo.',
        aiQueueFullError: 'Demasiados mensajes en cola. Espera la respuesta.'
      }
    };

    // ================= STATE =================
    let LANG = 'en';
    let PAGE = 'home';

    // Conversation holds only messages that were actually sent in-order
    let AI_CONVERSATION = [];
    let AI_QUEUE = [];         // queued user messages (strings) while waiting
    let AI_IN_FLIGHT = false;
    let AI_REQUEST_SEQ = 0;    // requestId

    const VALID_ROUTES = ['home', 'pricing', 'features', 'booking'];

    // Safety caps
    const MAX_CONVERSATION = 200;
    const MAX_QUEUE = 8;

    // ================= UTIL =================
    function esc(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function isFileProtocol() { return window.location.protocol === 'file:'; }

    function setApiPill(state) {
      const pill = document.getElementById('aiStatusPill');
      if (!pill) return;
      if (state === 'ok') pill.textContent = 'API: OK';
      else if (state === 'file') pill.textContent = 'API: file://';
      else if (state === 'rate') pill.textContent = 'API: 429';
      else if (state === 'down') pill.textContent = 'API: DOWN';
      else pill.textContent = 'API: ‚Ä¶';
    }

    function capConversation() {
      if (AI_CONVERSATION.length > MAX_CONVERSATION) {
        AI_CONVERSATION = AI_CONVERSATION.slice(-MAX_CONVERSATION);
      }
    }

    function setSendDisabled(disabled) {
      const btn = document.getElementById('sendBtn');
      if (btn) btn.disabled = !!disabled;
    }

    async function postJson(url, body, timeoutMs = 15000) {
      // Real timeout via AbortController
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), timeoutMs);

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(body),
          signal: ctrl.signal
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          const err = new Error(`http_${res.status}`);
          err.status = res.status;
          err.body = txt;
          throw err;
        }

        try {
          return await res.json();
        } catch (e) {
          const err = new Error('bad_json');
          err.cause = e;
          throw err;
        }
      } finally {
        clearTimeout(timer);
      }
    }

    // ================= LANGUAGE =================
    function selectLanguage(lang) {
      if (!T[lang]) lang = 'en';
      const remember = document.getElementById('rememberLang')?.checked ?? true;
      if (remember) localStorage.setItem('lang', lang);
      else sessionStorage.setItem('lang', lang);
      applyLanguage(lang);
      hideLangGate();
    }

    function applyLanguage(lang) {
      if (!T[lang]) lang = 'en';
      LANG = lang;
      document.documentElement.lang = lang;
      translateStatic();
      renderPage(PAGE);
      updateNav();

      const aiTitle = document.getElementById('aiTitle');
      if (aiTitle) aiTitle.textContent = T[LANG].aiTitle;
    }

    function translateStatic() {
      const t = T[LANG];
      const ids = [
        'langGateTitle','langGateSubtitle','rememberLangLabel',
        'navHome','navPricing','navFeatures','navCTA',
        'footerTagline','footerProduct','footerFeatures','footerPricing',
        'footerCompany','footerAbout','footerSecurity',
        'footerLegal','footerPrivacy','footerTerms','footerChangeLanguage',
        'footerCopyright',
        'demoModalTitle','demoNameLabel','demoEmailLabel','demoCompanyLabel','demoSubmit'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el && t[id]) el.textContent = t[id];
      });
    }

    function changeLanguage() {
      sessionStorage.removeItem('lang');
      localStorage.removeItem('lang');
      showLangGate();
    }

    function showLangGate() {
      document.getElementById('langGate')?.classList.remove('hidden');
      document.getElementById('site')?.classList.add('hidden');
    }

    function hideLangGate() {
      document.getElementById('langGate')?.classList.add('hidden');
      document.getElementById('site')?.classList.remove('hidden');
    }

    // ================= ROUTING =================
    function sanitizeRoute(route) {
      route = String(route).toLowerCase().replace(/[^a-z0-9-]/g, '');
      return VALID_ROUTES.includes(route) ? route : 'home';
    }

    function navigate(page) {
      window.location.hash = sanitizeRoute(page);
    }

    function handleHashChange() {
      let page = window.location.hash.slice(1) || 'home';
      page = sanitizeRoute(page);
      PAGE = page;

      renderPage(page);
      updateNav();
      window.scrollTo(0, 0);
    }

    function updateNav() {
      ['navHome', 'navPricing', 'navFeatures'].forEach(id => {
        document.getElementById(id)?.classList.remove('nav-active');
      });
      const key = 'nav' + PAGE.charAt(0).toUpperCase() + PAGE.slice(1);
      document.getElementById(key)?.classList.add('nav-active');
    }

    // ================= PAGES =================
    function renderPage(page) {
      const content = document.getElementById('content');
      if (!content) return;
      const t = T[LANG];
      let html = '';

      if (page === 'home') {
        html = `
          <section class="max-w-7xl mx-auto px-6 py-32">
            <div class="text-center animate">
              <h1 class="text-6xl md:text-7xl font-light text-white mb-6">${esc(t.heroTitle)}</h1>
              <p class="text-xl text-muted font-light mb-12 max-w-3xl mx-auto">${esc(t.heroSubtitle)}</p>
              <div class="flex gap-4 justify-center flex-wrap">
                <button type="button" onclick="openDemoModal()" class="btn-primary px-8 py-3 text-base font-medium">${esc(t.heroCTA)}</button>
                <button type="button" onclick="navigate('features')" class="btn-secondary px-8 py-3 text-base font-medium">${esc(t.heroSecondary)}</button>
              </div>
            </div>
          </section>

          <section class="max-w-7xl mx-auto px-6 py-20">
            <div class="text-center mb-16">
              <h2 class="text-4xl font-light text-white mb-4">${esc(t.featuresTitle)}</h2>
              <p class="text-lg text-muted font-light">${esc(t.featuresSubtitle)}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              ${[1,2,3,4].map(i => `
                <div class="glass-card p-8 hover:bg-[rgba(255,255,255,0.02)] transition">
                  <h3 class="text-xl font-medium text-white mb-3">${esc(t['feature'+i+'Title'])}</h3>
                  <p class="text-sm text-muted font-light">${esc(t['feature'+i+'Desc'])}</p>
                </div>
              `).join('')}
            </div>
          </section>

          <section class="max-w-7xl mx-auto px-6 py-20">
            <div class="glass-card p-12 text-center">
              <h2 class="text-4xl font-light text-white mb-4">${esc(t.ctaTitle)}</h2>
              <p class="text-lg text-muted font-light mb-8">${esc(t.ctaSubtitle)}</p>
              <button type="button" onclick="openDemoModal()" class="btn-primary px-8 py-3 text-base font-medium">${esc(t.ctaCTA)}</button>
            </div>
          </section>
        `;
      } else if (page === 'pricing') {
        html = `
          <section class="max-w-7xl mx-auto px-6 py-20">
            <div class="text-center mb-16">
              <h1 class="text-5xl font-light text-white mb-4">${esc(t.pricingTitle)}</h1>
              <p class="text-lg text-muted font-light">${esc(t.pricingSubtitle)}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
              ${['starter','pro','enterprise'].map((tier, idx) => `
                <div class="glass-card p-8 ${idx===1 ? 'border-white/30' : ''}">
                  <h3 class="text-2xl font-medium text-white mb-2">${esc(t[tier+'Title'])}</h3>
                  <div class="mb-4">
                    <span class="text-5xl font-light text-white">${esc(t[tier+'Price'])}</span>
                    <span class="text-sm text-muted ml-2">${esc(t[tier+'Per'])}</span>
                  </div>
                  <p class="text-sm text-muted mb-6">${esc(t[tier+'Desc'])}</p>
                  <button type="button" onclick="openDemoModal()" class="btn-primary w-full px-4 py-2.5 text-sm font-medium mb-6">${esc(t[tier+'CTA'])}</button>
                </div>
              `).join('')}
            </div>
          </section>

          <section class="max-w-4xl mx-auto px-6 py-20">
            <h2 class="text-3xl font-light text-white mb-8 text-center">${esc(t.faqTitle)}</h2>
            <div class="space-y-4">
              ${[1,2,3,4].map(i => `
                <div class="faq-item surface-card p-6">
                  <button type="button" onclick="toggleFaq(${i-1})" class="w-full text-left flex justify-between items-center">
                    <span class="text-base font-medium text-white">${esc(t['faqQ'+i])}</span>
                    <span class="text-white text-xl faq-icon" aria-hidden="true">+</span>
                  </button>
                  <div class="faq-answer mt-4">
                    <p class="text-sm text-muted font-light">${esc(t['faqA'+i])}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </section>
        `;
      } else if (page === 'features') {
        html = `
          <section class="max-w-7xl mx-auto px-6 py-20">
            <div class="text-center mb-16">
              <h1 class="text-5xl font-light text-white mb-4">${esc(t.featuresTitle)}</h1>
              <p class="text-lg text-muted font-light">${esc(t.featuresSubtitle)}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              ${[1,2,3,4].map(i => `
                <div class="glass-card p-10">
                  <h3 class="text-2xl font-medium text-white mb-4">${esc(t['feature'+i+'Title'])}</h3>
                  <p class="text-base text-muted font-light">${esc(t['feature'+i+'Desc'])}</p>
                </div>
              `).join('')}
            </div>
          </section>
        `;
      } else {
        html = `
          <section class="max-w-2xl mx-auto px-6 py-20">
            <h1 class="text-4xl font-light text-white mb-8 text-center">Book a Cleaning</h1>
            <div class="glass-card p-8">
              <p class="text-center text-muted">Booking form coming soon...</p>
              <div class="mt-6 flex justify-center">
                <button type="button" class="btn-primary px-6 py-2" onclick="openDemoModal()">Request Demo</button>
              </div>
            </div>
          </section>
        `;
      }

      content.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = html;
      content.appendChild(div);
    }

    function toggleFaq(idx) {
      const items = document.querySelectorAll('.faq-item');
      if (!items[idx]) return;
      items[idx].classList.toggle('open');
      const icon = items[idx].querySelector('.faq-icon');
      if (icon) icon.textContent = items[idx].classList.contains('open') ? '‚àí' : '+';
    }

    // ================= MODAL =================
    function openDemoModal() {
      document.getElementById('demoModal')?.classList.add('active');
      setTimeout(() => document.getElementById('demoName')?.focus(), 50);
    }

    function closeDemoModal() {
      document.getElementById('demoModal')?.classList.remove('active');
      document.getElementById('demoForm')?.reset();
      document.getElementById('demoSuccess')?.classList.add('hidden');
    }

    function submitDemo(e) {
      e.preventDefault();
      const success = document.getElementById('demoSuccess');
      if (success) {
        success.textContent = T[LANG].demoSuccess || 'Thank you! We will contact you soon.';
        success.classList.remove('hidden');
      }
      setTimeout(() => closeDemoModal(), 1500);
    }

    // ================= AI WIDGET =================
    function aiToggle() {
      const widget = document.getElementById('ai');
      if (!widget) return;

      const isOpen = !widget.classList.contains('hidden');
      if (isOpen) widget.classList.add('hidden');
      else {
        widget.classList.remove('hidden');
        if (AI_CONVERSATION.length === 0) aiWelcome();
        setTimeout(() => document.getElementById('inp')?.focus(), 50);
      }
    }

    function aiWelcome() {
      const msg = T[LANG].aiWelcome;
      addAiMessage(msg);
      AI_CONVERSATION.push({ role: 'assistant', content: msg });
      capConversation();

      setQuickActions([
        { text: 'Book cleaning', val: 'booking' },
        { text: 'Pricing', val: 'pricing' },
        { text: 'Features', val: 'features' }
      ]);

      if (isFileProtocol()) setApiPill('file');
      else setApiPill('‚Ä¶');

      setSendDisabled(false);
    }

    function aiReset() {
      if (!confirm(T[LANG].aiResetConfirm)) return;
      AI_CONVERSATION = [];
      AI_QUEUE = [];
      AI_IN_FLIGHT = false;
      document.getElementById('msgs').innerHTML = '';
      document.getElementById('quick').innerHTML = '';
      aiWelcome();
    }

    function queueSendFromInput() {
      const input = document.getElementById('inp');
      if (!input) return;
      const msg = input.value.trim();
      if (!msg) return;

      if (AI_QUEUE.length >= MAX_QUEUE) {
        addAiMessage(T[LANG].aiQueueFullError || 'Too many queued messages.');
        return;
      }

      input.value = '';

      // Render immediately (UX) but process sequentially (correct context)
      addUserMessage(msg);
      AI_QUEUE.push(msg);
      processAiQueue();
    }

    async function processAiQueue() {
      if (AI_IN_FLIGHT) return;
      if (AI_QUEUE.length === 0) return;

      const nextMsg = AI_QUEUE.shift();

      AI_CONVERSATION.push({ role: 'user', content: nextMsg });
      capConversation();

      AI_IN_FLIGHT = true;
      setSendDisabled(true);

      const myReqId = ++AI_REQUEST_SEQ;
      const typingId = addTypingIndicator();

      const payload = {
        tenantId: 'demo',
        locale: LANG,
        channel: 'web',
        messages: AI_CONVERSATION.slice(-30),
        context: { route: PAGE, url: window.location.href }
      };

      try {
        if (!navigator.onLine) throw Object.assign(new Error('offline'), { code: 'offline' });
        if (isFileProtocol()) throw Object.assign(new Error('file_protocol'), { code: 'file_protocol' });

        const data = await postJson('/api/ai/chat', payload, 15000);

        if (myReqId !== AI_REQUEST_SEQ) return; // very defensive

        setApiPill('ok');
        removeTypingIndicator(typingId);

        if (data && typeof data.assistantMessage === 'string') {
          addAiMessage(data.assistantMessage);
          AI_CONVERSATION.push({ role: 'assistant', content: data.assistantMessage });
          capConversation();
        } else {
          addAiMessage(T[LANG].aiGenericError);
          AI_CONVERSATION.push({ role: 'assistant', content: T[LANG].aiGenericError });
          capConversation();
        }

        if (Array.isArray(data?.quickActions) && data.quickActions.length) {
          setQuickActions(data.quickActions);
        }

        if (typeof data?.nav === 'string') {
          const nav = sanitizeRoute(data.nav);
          if (nav) navigate(nav);
        }
      } catch (err) {
        removeTypingIndicator(typingId);

        let msg = T[LANG].aiGenericError;
        let pillState = 'down';

        if (err?.code === 'offline') { msg = T[LANG].aiOfflineError; pillState = 'down'; }
        else if (err?.code === 'file_protocol') { msg = T[LANG].aiFileProtoError; pillState = 'file'; }
        else if (err?.name === 'AbortError') { msg = T[LANG].aiTimeoutError; pillState = 'down'; }
        else if (err?.status === 404) { msg = T[LANG].aiApiMissingError; pillState = 'down'; }
        else if (err?.status === 429) { msg = T[LANG].aiRateLimitError; pillState = 'rate'; }

        setApiPill(pillState);

        addAiMessage(msg);
        AI_CONVERSATION.push({ role: 'assistant', content: msg });
        capConversation();

        setQuickActions([
          { text: 'Pricing', val: 'pricing' },
          { text: 'Features', val: 'features' },
          { text: 'Book', val: 'booking' },
          { text: 'Request Demo', val: 'demo' }
        ]);
      } finally {
        AI_IN_FLIGHT = false;
        setSendDisabled(false);

        if (AI_QUEUE.length) {
          setTimeout(() => processAiQueue(), 0);
        }
      }
    }

    function addTypingIndicator() {
      const msgs = document.getElementById('msgs');
      if (!msgs) return null;

      const id = 'typing-' + Math.random().toString(16).slice(2);
      const row = document.createElement('div');
      row.className = 'flex gap-3';
      row.id = id;

      const avatar = document.createElement('div');
      avatar.className = 'w-8 h-8 bg-white/10 flex items-center justify-center text-white text-xs';
      avatar.textContent = 'AI';
      avatar.setAttribute('aria-hidden', 'true');

      const bubble = document.createElement('div');
      bubble.className = 'bg-[#363636] border border-white/10 px-4 py-3';

      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator';
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        indicator.appendChild(dot);
      }

      bubble.appendChild(indicator);
      row.appendChild(avatar);
      row.appendChild(bubble);

      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
      return id;
    }

    function removeTypingIndicator(id) {
      if (!id) return;
      document.getElementById(id)?.remove();
    }

    function addUserMessage(text) {
      const msgs = document.getElementById('msgs');
      if (!msgs) return;

      const row = document.createElement('div');
      row.className = 'flex gap-3 justify-end';

      const bubble = document.createElement('div');
      bubble.className = 'bg-white text-[#282828] px-4 py-3 max-w-[75%]';

      const p = document.createElement('p');
      p.className = 'text-sm font-light';
      p.textContent = text;

      bubble.appendChild(p);
      row.appendChild(bubble);

      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function addAiMessage(text) {
      const msgs = document.getElementById('msgs');
      if (!msgs) return;

      const row = document.createElement('div');
      row.className = 'flex gap-3';

      const avatar = document.createElement('div');
      avatar.className = 'w-8 h-8 bg-white/10 flex items-center justify-center text-white text-xs';
      avatar.textContent = 'AI';
      avatar.setAttribute('aria-hidden', 'true');

      const bubble = document.createElement('div');
      bubble.className = 'bg-[#363636] border border-white/10 px-4 py-3 max-w-[75%]';

      const p = document.createElement('p');
      p.className = 'text-sm font-light text-white';
      p.textContent = text;

      bubble.appendChild(p);
      row.appendChild(avatar);
      row.appendChild(bubble);

      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function setQuickActions(actions) {
      const quick = document.getElementById('quick');
      if (!quick) return;

      quick.innerHTML = '';
      (actions || []).slice(0, 8).forEach(a => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'text-xs bg-white/5 border border-white/10 px-3 py-2 hover:bg-white/10 transition font-light text-white';
        btn.style.minHeight = '44px';
        btn.textContent = String(a.text || '').slice(0, 40);

        btn.onclick = () => {
          const v = (a.val || a.text || '').toString().trim();
          if (!v) return;

          const lower = v.toLowerCase();
          if (lower === 'demo') { openDemoModal(); return; }
          if (['pricing','features','home','booking'].includes(lower)) { navigate(lower); return; }

          // otherwise send as message
          if (AI_QUEUE.length >= MAX_QUEUE) {
            addAiMessage(T[LANG].aiQueueFullError || 'Too many queued messages.');
            return;
          }

          addUserMessage(v);
          AI_QUEUE.push(v);
          processAiQueue();
        };

        quick.appendChild(btn);
      });
    }

    // ================= INIT =================
    window.addEventListener('hashchange', handleHashChange);

    window.addEventListener('load', () => {
      const saved = localStorage.getItem('lang') || sessionStorage.getItem('lang');

      if (saved && T[saved]) {
        LANG = saved;
        document.documentElement.lang = saved;
        translateStatic();
        hideLangGate();
        handleHashChange(); // renders + updates nav
      } else {
        showLangGate();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const widget = document.getElementById('ai');
        const modal = document.getElementById('demoModal');
        if (widget && !widget.classList.contains('hidden')) aiToggle();
        else if (modal && modal.classList.contains('active')) closeDemoModal();
      }
    });
  </script>
</body>
</html>
